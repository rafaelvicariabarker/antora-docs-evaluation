<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: devonfw Documentation</title>
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">devonfw Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="devonfw" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Cobigen</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Usage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/cobigen-eclipse_usage">Usage of the eclipse UI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/cobigen-openapiplugin#usage">OpenAPI Generation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/howto_ionic-client-generation">Ionic/Cordova Client Generation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/howto_angular-client-generation">Angular Client Generation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/cobigen-maven_configuration">Usage in Maven Builds</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/cobigen-core_configuration">Configuration of the Templates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki/cobigen-eclipse_installation">For eclipse users</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://github.com/devonfw/cobigen/wiki#architecture">CobiGen is build as an extensible framework for incremental code generation&#8230;&#8203;</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cobigen</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/rafaelvicariabarker/devon4j/edit/refactorForAntora/modules/ROOT/pages/guide-jpa-query.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_queries">Queries</a></li>
<li><a href="#_static_queries">Static Queries</a>
<ul class="sectlevel2">
<li><a href="#_using_queries_to_avoid_bidirectional_relationships">Using Queries to Avoid Bidirectional Relationships</a></li>
</ul>
</li>
<li><a href="#_dynamic_queries">Dynamic Queries</a></li>
<li><a href="#_using_wildcards">Using Wildcards</a></li>
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_paging_with_querydsl">Paging with QueryDSL</a></li>
<li><a href="#_pagination_example">Pagination example</a></li>
<li><a href="#_pagingation_in_devon4j_spring">Pagingation in devon4j-spring</a></li>
</ul>
</li>
<li><a href="#_query_meta_parameters">Query Meta-Parameters</a></li>
<li><a href="#_advanced_queries">Advanced Queries</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_queries"><a class="anchor" href="#_queries"></a>Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">Java Persistence API (JPA)</a> defines its own query language, the <a href="https://docs.oracle.com/html/E13946_01/ejb3_langref.html"><em>java persistence query language</em> (JPQL)</a> (see also <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-querylanguage.htm">JPQL tutorial</a>), which is similar to SQL but operates on entities and their attributes instead of tables and columns.</p>
</div>
<div class="paragraph">
<p>The simplest CRUD-Queries (e.g. find an entity by its ID) are already build in the devonfw CRUD functionality (via <a href="guide-repository.html" class="xref page">Repository</a> or <a href="guide-dao.html" class="xref page">DAO</a>). For other cases you need to write your own query. We distinguish between <em>static</em> and <em>dynamic</em> queries. <a href="#static-queries">Static queries</a> have a fixed JPQL query string that may only use parameters to customize the query at runtime. Instead, <a href="#dynamic-queries">dynamic queries</a> can change their clauses (<code>WHERE</code>, <code>ORDER BY</code>, <code>JOIN</code>, etc.) at runtime depending on the given search criteria.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_static_queries"><a class="anchor" href="#_static_queries"></a>Static Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>E.g. to find all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/DishEntity.java">DishEntries</a> (from MTS sample app) that have a price not exceeding a given <code>maxPrice</code> we write the following JPQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT dish FROM DishEntity dish WHERE dish.price &lt;= :maxPrice</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>dish</code> is used as alias (variable name) for our selected <code>DishEntity</code> (what refers to the simple name of the Java entity class). With <code>dish.price</code> we are referring to the Java property <code>price</code> (<code>getPrice()</code>/<code>setPrice(&#8230;&#8203;)</code>) in <code>DishEntity</code>. A named variable provided from outside (the search criteria at runtime) is specified with a colon (<code>:</code>) as prefix. Here with <code>:maxPrice</code> we reference to a variable that needs to be set via <code>query.setParameter("maxPrice", maxPriceValue)</code>. JPQL also supports indexed parameters (<code>?</code>) but they are discouraged because they easily cause confusion and mistakes.</p>
</div>
<div class="sect2">
<h3 id="_using_queries_to_avoid_bidirectional_relationships"><a class="anchor" href="#_using_queries_to_avoid_bidirectional_relationships"></a>Using Queries to Avoid Bidirectional Relationships</h3>
<div class="paragraph">
<p>With the usage of queries it is possible to avoid exposing relationships or modelling bidirectional relationships, which have some disadvantages (see <a href="guide-jpa.html#relationships" class="xref page">relationships</a>). This is especially desired for relationships between entities of different business components.
So for example to get all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderLineEntity.java">OrderLineEntities</a> for a specific <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderEntity.java">OrderEntity</a> without using the <code>orderLines</code> relation from <code>OrderEntity</code> the following query could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT line FROM OrderLineEntity line WHERE line.order.id = :orderId</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic_queries"><a class="anchor" href="#_dynamic_queries"></a>Dynamic Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For dynamic queries we use <a href="http://www.querydsl.com/">QueryDSL</a>. It allows to implement queries in a powerful but readable and type-safe way (unlike Criteria API). If you already know JPQL you will quickly be able to read and write QueryDSL code. It feels like JPQL but implemented in Java instead of plain text.</p>
</div>
<div class="paragraph">
<p>Here is an example from our sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  public List&lt;DishEntity&gt; findDishes(DishSearchCriteriaTo criteria) {
    QDishEntity dish = QDishEntity.dishEntity;
    JPAQuery&lt;DishEntity&gt; query = new JPAQuery&lt;OrderEntity&gt;(getEntityManager());
    query.from(dish);

    Range&lt;BigDecimal&gt; priceRange = criteria.getPriceRange();
    if (priceRange != null) {
      BigDecimal min = priceRange.getMin();
      if (min != null) {
        query.where(dish.price.goe(min));
      }
      BigDecimal max = priceRange.getMax();
      if (max != null) {
        query.where(dish.price.loe(max));
      }
    }
    String name = criteria.getName();
    if ((name != null) &amp;&amp; (!name.isEmpty())) {
      query.where(dish.name.eq(name));
    }
    return query.fetch();
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we use the so called Q-types (<code>QDishEntity</code>). These are classes generated at build time by the QueryDSL annotation processor from entity classes. The Q-type classes can be used as static types representative of the original entity class.</p>
</div>
<div class="paragraph">
<p>For spring, devon4j provides another approach that you can use for your Spring applications to implement QueryDSL logic without having to use these metaclasses. An example can be found <a href="spring/guide-querydsl-spring.html" class="xref page">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_wildcards"><a class="anchor" href="#_using_wildcards"></a>Using Wildcards</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For flexible queries it is often required to allow wildcards (especially in <a href="#dynamic_queries">dynamic queries</a>). While users intuitively expect glob syntax the SQL and JPQL standards work different. Therefore a mapping is required. devonfw provides this on a lower level by <a href="https://github.com/devonfw/devon4j/blob/develop/modules/basic/src/main/java/com/devonfw/module/basic/common/api/query/LikePatternSyntax.java">LikePatternSyntax</a> and on a high level by <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java#L54">QueryUtil</a> (see <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L199">QueryHelper.newStringClause(&#8230;&#8203;)</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination"><a class="anchor" href="#_pagination"></a>Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When dealing with large amounts of data, an efficient method of retrieving the data is required. Fetching the entire data set each time would be too time consuming. Instead, <em>Paging</em> is used to process only small subsets of the entire data set.</p>
</div>
<div class="paragraph">
<p>If you are using <a href="guide-repository.html" class="xref page">Spring Data repositories</a> you will get pagination support out of the box by providing the interfaces <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Page</a> and  <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Pageable</a>:</p>
</div>
<div class="listingblock">
<div class="title"><strong>repository</strong></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Page&lt;DishEntity&gt; findAll(Pageable pageable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can create a Pageable object and pass it to the method call as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">int page = criteria.getPageNumber();
int size = criteria.getPageSize();
Pageable pageable = PageRequest.of(page, size);
Page&lt;DishEntity&gt; dishes = dishRepository.findAll(pageable);</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_paging_with_querydsl"><a class="anchor" href="#_paging_with_querydsl"></a>Paging with QueryDSL</h3>
<div class="paragraph">
<p>Pagination is also supported for dynamic queries with QueryDSL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  public Page&lt;DishEntity&gt; findDishes(DishSearchCriteriaTo criteria) {
    QDishEntity dish = QDishEntity.dishEntity;
    JPAQuery&lt;DishEntity&gt; query = new JPAQuery&lt;OrderEntity&gt;(getEntityManager());
    query.from(dish);

    // conditions

    int page = criteria.getPageNumber();
    int size = criteria.getPageSize();
    Pageable pageable = PageRequest.of(page, size);
    query.offset(pageable.getOffset());
    query.limit(pageable.getPageSize());

    List&lt;DishEntity&gt; dishes = query.fetch();
    return new PageImpl&lt;&gt;(dishes, pageable, dishes.size());
  }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pagination_example"><a class="anchor" href="#_pagination_example"></a>Pagination example</h3>
<div class="paragraph">
<p>For the table entity we can make a search request by accessing the REST endpoint with pagination support like in the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  "pagination": {
    "size":2,
    "total":true
  }
}

//Response
{
    "pagination": {
        "size": 2,
        "page": 1,
        "total": 11
    },
    "result": [
        {
            "id": 101,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 1,
            "state": "OCCUPIED"
        },
        {
            "id": 102,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 2,
            "state": "FREE"
        }
    ]
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As we are requesting with the <code>total</code> property set to <code>true</code> the server responds with the total count of rows for the query.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For retrieving a concrete page, we provide the <code>page</code> attribute with the desired value. Here we also left out the <code>total</code> property so the server doesn&#8217;t incur on the effort to calculate it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  "pagination": {
    "size":2,
    "page":2
  }
}

//Response

{
    "pagination": {
        "size": 2,
        "page": 2,
        "total": null
    },
    "result": [
        {
            "id": 103,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 3,
            "state": "FREE"
        },
        {
            "id": 104,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 4,
            "state": "FREE"
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pagingation_in_devon4j_spring"><a class="anchor" href="#_pagingation_in_devon4j_spring"></a>Pagingation in devon4j-spring</h3>
<div class="paragraph">
<p>For spring applications, devon4j also offers its own solution for pagination. You can find an example of this <a href="spring/guide-querydsl-spring.html#pagination" class="xref page">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_meta_parameters"><a class="anchor" href="#_query_meta_parameters"></a>Query Meta-Parameters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Queries can have meta-parameters and that are provided via <code>SearchCriteriaTo</code>. Besides paging (see above) we also get <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L51">timeout support</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_queries"><a class="anchor" href="#_advanced_queries"></a>Advanced Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Writing queries can sometimes get rather complex. The current examples given above only showed very simple basics. Within this topic a lot of advanced features need to be considered like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.w3schools.com/sql/sql_join.asp">Joins</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/html/E13946_04/ejb3_langref.html#ejb3_langref_constructor">Constructor queries</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_orderby.asp">Order By</a> (Sorting)</p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_groupby.asp">Grouping</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_having.asp">Having</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_union.asp">Unions</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/cd/E11035_01/kodo41/full/html/ejb3_langref.html#ejb3_langref_subqueries">Sub-Queries</a></p>
</li>
<li>
<p>Aggregation functions like e.g. <a href="https://www.w3schools.com/sql/sql_count_avg_sum.asp">count/avg/sum</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_distinct.asp">Distinct selections</a></p>
</li>
<li>
<p>SQL Hints (see e.g. <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#i8327">Oracle hints</a> or <a href="http://sqlhints.com/">SQL-Server hints</a>) - only when required for ultimate performance tuning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This list is just containing the most important aspects. As we can not cover all these topics here, they are linked to external documentation that can help and guide you.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
